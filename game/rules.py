"""Правила игры Сапёр и их базовая реализация.

Модуль содержит абстракцию правил (GameRules) и классические правила
ClassicMinesweeperRules. В дальнейшем здесь можно добавлять расширенные
режимы с особыми механиками, не меняя логику Board.
"""

from __future__ import annotations

from typing import Protocol

from core.board import Board
from core.results import BoardUpdateResult


class GameRules(Protocol):
    """Протокол правил игры Сапёр.

    Реализации этого протокола могут расширять базовое поведение:
    добавлять особые типы мин, бонусы, альтернативные условия победы
    и т.п., не меняя сам класс Board.

    Это протокол для статической типизации. На уровне выполнения
    проверок абстрактности не производится.
    """

    def open_tile(self, board: Board, x: int, y: int) -> BoardUpdateResult:
        """Открыть клетку по правилам текущего режима.

        Args:
            board:
                Экземпляр игрового поля.
            x:
                Индекс столбца клетки.
            y:
                Индекс строки клетки.

        Returns:
            Объект BoardUpdateResult с результатом открытия.
        """

    def toggle_flag(self, board: Board, x: int, y: int) -> int:
        """Переключить пометку клетки по правилам текущего режима.

        Обычно это просто делегирование методу Board.toggle_flag(),
        но в расширенных режимах можно изменять поведение (например,
        ограничивать количество флагов или вводить дополнительные типы
        пометок).

        Args:
            board:
                Экземпляр игрового поля.
            x:
                Индекс столбца клетки.
            y:
                Индекс строки клетки.

        Returns:
            Изменение счётчика флагов:
                +1 — флаг был установлен;
                -1 — флаг был снят;
                 0 — счётчик не изменился.
        """


class ClassicMinesweeperRules(GameRules):
    """Классические правила Сапёра.

    Реализует поведение, соответствующее канонической игре:

    * первый клик безопасен (делегируется Board.open_tile, где уже
      реализована безопасная зона);
    * при открытии клетки используется flood fill;
    * флаги переключаются через Board.toggle_flag().
    """

    def open_tile(self, board: Board, x: int, y: int) -> BoardUpdateResult:
        """Открыть клетку по классическим правилам.

        Args:
            board:
                Экземпляр игрового поля.
            x:
                Индекс столбца клетки.
            y:
                Индекс строки клетки.

        Returns:
            Объект BoardUpdateResult с результатом открытия.
        """
        return board.open_tile(x=x, y=y, safe_first_click=True)

    def toggle_flag(self, board: Board, x: int, y: int) -> int:
        """Переключить флаг на клетке по классическим правилам.

        Args:
            board:
                Экземпляр игрового поля.
            x:
                Индекс столбца клетки.
            y:
                Индекс строки клетки.

        Returns:
            Изменение счётчика флагов:
                +1 — флаг был установлен;
                -1 — флаг был снят;
                 0 — счётчик не изменился.
        """
        return board.toggle_flag(x=x, y=y)
